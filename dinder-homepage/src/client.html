<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dinder Lobby</title>
</head>
<body>
  <h1>Dinder Lobby</h1>

  <!-- Initial Page Elements -->
  <div id="initialPage">
    <button onclick="createRoom()">Create Room</button>
    <input type="text" id="roomCodeInput" placeholder="Enter Room Code">
    <input type="text" id="nicknameInput" placeholder="Enter Your Nickname">
    <button onclick="joinRoom()">Join Room</button>
  </div>

  <!-- Lobby Page Elements -->
  <div id="lobbyPage" style="display: none;">
    <h2>Lobby</h2>
    <p>Room Code: <span id="roomCodeDisplay"></span></p>
    <h3>Participants</h3>
    <ul id="participantsList"></ul>
    <button onclick="leaveRoom()">Leave Room</button>
  </div>

  <script>
    const socket = new WebSocket("ws://localhost:8524");

    // Track the current room code and nickname
    let currentRoomCode = null;
    let currentNickname = null;

    // WebSocket event listeners
    socket.onopen = () => console.log("Connected to WebSocket server");
    socket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      handleServerMessage(message);
    };

    // Handle different message types from the server
    function handleServerMessage(message) {
      switch (message.messageType) {
        case 'ROOM_CREATED_SUCCESS':
          currentRoomCode = message.roomCode;
          document.getElementById('roomCodeDisplay').textContent = message.roomCode;
          showLobby();
          break;

        case 'PLAYER_JOINED':
          if (message.roomCode === currentRoomCode) {
            updateParticipantsList(message.players);
          }
          break;

        case 'ERROR_INVALID_ROOM':
          alert("Room code is invalid. Please try again.");
          break;

        case 'ERROR_NAME_TAKEN':
          alert("Nickname is already taken in this room. Please choose another.");
          break;

        case 'PLAYER_LEFT':
          if (message.roomCode === currentRoomCode) {
            removeParticipant(message.nickname);
          }
          break;

        default:
          console.log("Unknown message type:", message.messageType);
      }
    }

    // Functions to manage room creation, joining, and leaving
    function createRoom() {
      if (!currentRoomCode) {
        const nickname = document.getElementById("nicknameInput").value.trim();
        if (!nickname) {
          alert("Please enter a nickname.");
          return;
        }
        currentNickname = nickname;
        socket.send(JSON.stringify({ messageType: 'CREATE_ROOM_REQUEST', nickname }));
      } else {
        alert("You are already in a room. Please leave the current room first.");
      }
    }

    function joinRoom() {
      if (!currentRoomCode) {
        const roomCode = document.getElementById("roomCodeInput").value.trim().toUpperCase();
        const nickname = document.getElementById("nicknameInput").value.trim();
        if (!roomCode || !nickname) {
          alert("Please enter both a room code and a nickname.");
          return;
        }
        currentNickname = nickname;
        socket.send(JSON.stringify({ messageType: 'ROOM_JOIN_REQUEST', roomCode, nickname }));
      } else {
        alert("You are already in a room. Please leave the current room first.");
      }
    }

    function leaveRoom() {
      if (currentRoomCode) {
        socket.send(JSON.stringify({ messageType: 'DISCONNECTED' }));
        resetView();
      }
    }

    // Display lobby and update participant list
    function showLobby() {
      document.getElementById('initialPage').style.display = 'none';
      document.getElementById('lobbyPage').style.display = 'block';
      document.getElementById('roomCodeDisplay').textContent = currentRoomCode;
    }

    function updateParticipantsList(players) {
      const participantsList = document.getElementById('participantsList');
      participantsList.innerHTML = '';
      players.forEach(player => {
        const listItem = document.createElement('li');
        listItem.textContent = player.nickname + (player.vip ? " (Host)" : "");
        participantsList.appendChild(listItem);
      });
    }

    function removeParticipant(nickname) {
      const participantsList = document.getElementById('participantsList');
      [...participantsList.children].forEach((child) => {
        if (child.textContent.startsWith(nickname)) {
          participantsList.removeChild(child);
        }
      });
    }

    function resetView() {
      currentRoomCode = null;
      currentNickname = null;
      document.getElementById('roomCodeInput').value = '';
      document.getElementById('nicknameInput').value = '';
      document.getElementById('initialPage').style.display = 'block';
      document.getElementById('lobbyPage').style.display = 'none';
      document.getElementById('participantsList').innerHTML = '';
    }
  </script>
</body>
</html>
